#!/bin/bash

{% macro section(text) -%}
cat <<EOF
###############################################################################
# {{text}}
###############################################################################
EOF
{%- endmacro%}

{{section("config")}}
set -e

export DEBIAN_FRONTEND=noninteractive

{{section("Wifi")}}
{% if wifi.ssid | length %}
nmcli r wifi on
nmcli d wifi connect {{wifi.ssid}} password {{wifi.pw}}
{% endif %}

{{section("eth0")}}
NM_CONF_DIR="/etc/NetworkManager/system-connections/"
{% for cfg in nm_configs %}
cat >$NM_CONF_DIR/{{cfg.file}} <<EOF
{{cfg.content}}
EOF
{%endfor%}

{{section("/etc/profile.d")}}
cat > /etc/profile.d/local-path.sh << EOF
export PATH="~/.local/bin:$PATH"
EOF

{{section("Apt packages")}}
apt install -y libavcodec-dev libavformat-dev libavutil-dev libswscale-dev libsdl2-dev \
  libsqlite3-dev libssl-dev libboost-dev libfmt-dev
apt install -y rclone python3 python3-pip weston
apt install -y vim ninja-build git cmake

{{section("pip packages")}}
sudo -su user pip install --user --break-system-packages meson

{{section("Compile plai")}}
sudo -su user << EOF
set -e
export PATH="~/.local/bin:$PATH"
[ -d ~/code/plai ] || (mkdir -p ~/code && git clone https://github.com/tlammi/plai.git ~/code/plai)
cd ~/code/plai
git checkout {{plai}}
meson setup --optimization=3 -Dtests=false build
ninja -C build
EOF

{{section("Install plai")}}
ninja -C ~user/code/plai/build

{{section("Systemd units")}}
SYSTEMD_UNIT_DIR="/etc/systemd"
{% for unit in units %}
mkdir -p "$(dirname "$SYSTEMD_UNIT_DIR/{{unit.file}}")"
cat >$SYSTEMD_UNIT_DIR/{{unit.file}} <<EOF
{{unit.content}}
EOF
{% endfor %}

{{section("Enable systemd units")}}
{% macro systemd_user(args) -%}
systemd -M user@ --user {{args}}
{% endmacro -%}

{{systemd_user("enable plai.service")}}
{{systemd_user("enable rclone.service")}}
{{systemd_user("enable mplayer.service")}}

{{section("Done")}}
